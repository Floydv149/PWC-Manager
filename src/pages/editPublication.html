<style>
    #publicationQR {
        width: 100px;
        border-radius: 10px;
    }

    #imagePreview {
        width: 100px;
        border-radius: 10px;
    }
</style>

<body>
    <h2 class="center" id="header"><img src="/assets/icons/pen.png">EDIT PUBLICATION</h2>
    <p class="center" id="description">Fill in the details below to edit the publication info.</p>
    <hr>
    <form id="editPublicationForm">
        <div class="formGroup">
            <label for="title">Title</label>
            <input type="text" name="title" placeholder="Enter publication title" required>
        </div>
        <hr>
        <div class="formGroup">
            <p>Enter the code on the back of the publication for easy entering or enter manually below.<br><br>
                <!-- <div class="formGroup"> -->
                <label for="code">Code</label>
                <input type="text" name="code" placeholder="Enter publication code" required onchange="processCode()">
                <!-- </div> -->
            </p>
            <img id="publicationQR" onclick="fullScreen(this)" class="center" src="/assets/guides/publicationQR.png">
        </div>
        <a class="normal rounded small full" onclick="processCode()"><img src="/assets/icons/checkBox.png">Enter</a>
        <hr>
        <p class="center">OR</p>
        <hr>
        <div class="formGroup">
            <label for="code">Category</label>
            <select name="category" required>
                <option value="">Select category</option>
            </select>
        </div>
        <div class="formGroup">
            <label for="imageURL">Image URL</label>
            <input type="text" name="imageURL" placeholder="Enter thumbnail URL" required>
        </div>
        <img class="center" id="imagePreview" onclick="fullScreen(this)">
        <div class="formGroup">
            <label for="date">Date</label>
            <input type="date" name="date" required>
        </div>
    </form>
    <hr>
    <a id="saveButton" class="normal rounded full medium" onclick="save();"><img src="/assets/icons/save.png">Save
        changes</a>
    <a class="normal rounded full medium" onclick="deletePublication();"><img src="/assets/icons/trash.png">Delete
        publication</a>
    <a <a class="normal rounded full small" onclick="cancel();"><img src="/assets/icons/close.png">Cancel</a>
</body>
<script>
    function initForm() {
        if (session.newPublication) {
            document.getElementById('header').innerHTML = "<img src='/assets/icons/pen.png'>ADD PUBLICATION";
            document.getElementById('description').innerText = "Fill in the details below to add a new publication.";
            document.getElementById('saveButton').innerHTML = "<img src='/assets/icons/add.png'>Add publication";
        }

        const form = document.getElementById('editPublicationForm');
        const publicationIndex = session.currentPublicationIndex;
        const publication = data.library[publicationIndex];

        for (const categoryID in data.categories) {
            const category = data.categories[categoryID];
            const option = document.createElement('option');
            option.value = categoryID;
            option.textContent = category.name;
            form.category.appendChild(option);
        }

        form.title.value = publication.title;
        form.category.value = publication.categoryID;
        form.imageURL.value = publication.imageURL;
        form.date.value = publication.data;

        session.navigateBackCancelFunction = deleteNewPublication;
    }

    initForm();

    function save() {
        const form = document.getElementById('editPublicationForm');
        const publicationIndex = session.currentPublicationIndex;
        const publication = data.library[publicationIndex];

        if (form.title.value == "") {
            form.title.value = "Untitled";
        }

        if (form.imageURL.value == "") {
            form.imageURL.value = "/assets/icons/unknownPublication.png";
        }

        publication.title = form.title.value;
        publication.categoryID = form.category.value;
        publication.imageURL = form.imageURL.value;
        publication.data = form.date.value;

        saveData();
        session.newPublication = false;

        navigateBack();
    }

    async function processCode() {
        const form = document.getElementById('editPublicationForm'); const publicationIndex = session.currentPublicationIndex;
        const publication = data.library[publicationIndex];

        document.getElementById('imagePreview').src = "/assets/icons/loading.gif";
        form.category.value = 0;
        form.imageURL.value = "/assets/icons/unknownPublication.png";
        form.date.value = "0000-00-00";

        const code = form.code.value;

        try {

            const pubtypeRegex = /^\D*/;
            const pubType = code.match(pubtypeRegex)[0].toLowerCase();

            //Category
            for (const categoryID in data.categories) {
                console.log(data.categories[categoryID].jworgCode);
                if (data.categories[categoryID].jworgCode == pubType) {
                    form.category.value = categoryID;
                    console.log(categoryID);
                }
            }

            if (form.category.value == "") {
                form.category.value = 0;
            }

            //Image URL part 1
            let possibleDates = [];

            //Date
            const dateRegex = /(\d+)\.(\d+)/;
            const year = code.match(dateRegex)[1];
            const edition = code.match(dateRegex)[2];

            if (edition == 1) {
                possibleDates = ["01", "03", "05", "07", "09", "11"];
            } else if (edition == 2) {
                possibleDates = ["05", "07"];
            } else if (edition == 3) {
                possibleDates = ["09", "11"];
            }

            let languageID;

            languageID = code.split('-').pop();
            if (languageID == code) {
                languageID = "E";
            }

            let correctDate = "";

            for (let i = 0; i < possibleDates.length; i++) {
                const possibleDate = possibleDates[i];
                const possibleURL = `https://cms-imgp.jw-cdn.org/img/p/${pubType}/20${year}${possibleDate}/${languageID}/pt/${pubType}_${languageID}_20${year}${possibleDate}_lg.jpg`

                const response = await fetch(possibleURL);
                if (response.ok) {
                    form.imageURL.value = possibleURL;
                    document.getElementById('imagePreview').src = possibleURL;
                    correctDate = "20" + year + "-" + possibleDate + "-01";
                    break;
                }
            }

            if (correctDate == "") {
                document.getElementById('imagePreview').src = "/assets/icons/unknownPublication.png";
            }

            form.date.value = correctDate;
        } catch (error) {
            console.log(error);
        }
    }

    function deletePublication() {
        openYesNoModal("trash", "DELETE PUBLICATION", "<p class='center'>Are you sure you want to delete this publication?<br>All it's data will be lost and every reference will be removed.</p>", "Yes", "No").then((result) => {
            if (result) {

                //Delete publication if not new
                if (!session.newPublication) {
                    //Remove every reference
                    for (const designID in data.designs) {
                        const design = data.designs[designID];
                        const publications = design.publications;

                        for (let i = 0; i < publications.length; i++) {
                            for (let j = 0; j < publications[i].length; j++) {
                                if (publications[i][j] == session.currentPublicationIndex) {
                                    publications[i][j] = 0;
                                }
                            }
                        }

                    }

                    //Remove from library
                    delete data.library[session.currentPublicationIndex];

                    saveData();
                }

                openAlertModal("checkBox", "PUBLICATION DELETED", "<p class='center'>The publication has been deleted successfully.</p>", "Okay").then(() => {
                    navigateBack();
                });
            }
        });
    }

    function deleteNewPublication() {
        if (session.newPublication) {
            delete data.library[session.currentPublicationIndex];
        }

        saveData();
    }

    function cancel() {
        session.newPublication = false;

        navigateBack();
    }
</script>