<style>
    #publicationQR {
        width: 100px;
        border-radius: 10px;
    }

    #imagePreview {
        max-width: 94.29px !important;
        min-width: 94.29px;
        max-height: 128.66px !important;
        min-height: 128.66px;
        object-fit: contain;
        border-radius: 10px;
    }

    .countControl {
        display: block;
        width: 100%;
        margin: 0px auto;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
    }

    .countControl img {
        margin: 0px;
        display: inline;
        max-width: 25px;
    }

    .countControl p {
        padding: 0px 10px;
    }
</style>

<body>
    <h2 class="center" id="header"><img src="/assets/icons/pen.png">EDIT PUBLICATION</h2>
    <p class="center" id="description">Fill in the details below to edit the publication info.</p>
    <details open>
        <summary><img src="/assets/icons/info.png">Details</summary>
        <hr>
        <form id="editPublicationForm">
            <div class="formGroup">
                <label for="title">Title</label>
                <input type="text" name="title" placeholder="Enter publication title" required>
            </div>
            <hr>
            <div class="formGroup">
                <p>Enter the code on the back of the publication for easy entering or enter/edit manually below.<br><br>
                    <!-- <div class="formGroup"> -->
                    <label for="code">Code</label>
                    <input type="text" name="code" placeholder="Enter publication code" required
                        onchange="processCode()">
                    <!-- </div> -->
                </p>
                <img id="publicationQR" onclick="fullScreen(this)" class="center"
                    src="/assets/guides/publicationQR.png">
            </div>
            <a class="normal rounded small full" onclick="processCode()"><img src="/assets/icons/checkBox.png">Enter</a>
            <hr>
            <p class="center">OR</p>
            <hr>
            <div class="formGroup">
                <label for="code">Category</label>
                <select name="category" required>
                    <option value="">Select category</option>
                </select>
            </div>
            <div class="formGroup">
                <label for="imageURL">Image URL</label>
                <input type="text" name="imageURL" placeholder="Enter thumbnail URL" required>
            </div>
            <img class="center" id="imagePreview" onclick="fullScreen(this)">
            <div class="formGroup">
                <label for="date">Date</label>
                <input type="date" name="date" required>
            </div>
        </form>
        <hr>
        <a id="saveButton" class="normal rounded full medium" onclick="save();"><img src="/assets/icons/save.png">Save
            changes</a>
        <a class="normal rounded full medium" onclick="deletePublication();"><img src="/assets/icons/trash.png">Delete
            publication</a>
        <a class="normal rounded full small" onclick="cancel();"><img src="/assets/icons/close.png">Cancel</a>
    </details>
    <details open>
        <summary><img src="/assets/icons/shelf.png">Inventory</summary>
        <div id="inventory">

        </div>
    </details>
</body>
<script>
    function initForm() {
        if (session.newPublication) {
            document.getElementById('header').innerHTML = "<img src='/assets/icons/pen.png'>ADD PUBLICATION";
            document.getElementById('description').innerText = "Fill in the details below to add a new publication.";
            document.getElementById('saveButton').innerHTML = "<img src='/assets/icons/add.png'>Add publication";
        }

        const form = document.getElementById('editPublicationForm');
        const publicationIndex = session.currentPublicationIndex;
        const publication = data.library[publicationIndex];

        for (const categoryID in globals.categories) {
            const category = globals.categories[categoryID];
            const option = document.createElement('option');
            option.value = categoryID;
            option.textContent = category.name;
            form.category.appendChild(option);
        }

        form.title.value = publication.title;
        form.category.value = publication.categoryID;
        form.imageURL.value = publication.imageURL;
        form.date.value = publication.date;

        document.getElementById('imagePreview').src = publication.imageURL;

        const inventory = document.getElementById("inventory");

        if (!publication.inventory || Object.keys(publication.inventory).length == 0) {
            publication.inventory = {
                "General": 0
            }
        }

        for (const storageLocation in publication.inventory) {
            inventory.innerHTML += `
            <h4 class="center">`+ storageLocation + `</h4>
            <div class="countControl">
                <img src="/assets/icons/remove.png" onclick="removeSupplies(this, '${publicationIndex}')">
                <p>${publication.inventory[storageLocation]}</p>
                <img src="/assets/icons/add.png" onclick="addSupplies(this, '${publicationIndex}')">
            </div>
            `
        }

        session.navigateBackCancelFunction = deleteNewPublication;
    }

    initForm();

    function save() {
        const form = document.getElementById('editPublicationForm');
        const publicationIndex = session.currentPublicationIndex;
        const publication = data.library[publicationIndex];

        if (form.title.value == "") {
            form.title.value = "Untitled";
        }

        if (form.imageURL.value == "") {
            form.imageURL.value = "/assets/icons/unknownPublication.png";
        }

        publication.title = form.title.value;
        publication.categoryID = parseInt(form.category.value);
        publication.imageURL = form.imageURL.value;
        publication.date = form.date.value;

        saveData();
        session.newPublication = false;

        navigateBack();
    }

    async function processCode() {
        if (!navigator.onLine) {
            openAlertModal("offline", "OFFLINE", "<p class='center'>You are currently offline, and you cannot add a publication through a code when offline. Please check your internet connection and try again.</p>");

            return;
        }

        const form = document.getElementById('editPublicationForm');
        const publicationIndex = session.currentPublicationIndex;
        const publication = data.library[publicationIndex];
        if (form.code == "") {
            return;
        }

        document.getElementById('imagePreview').src = "/assets/icons/loading.gif";
        form.category.value = 0;
        form.imageURL.value = "/assets/icons/unknownPublication.png";
        form.date.value = "0000-00-00";

        const code = form.code.value;
        let found = false;

        try {

            const pubtypeRegex = /^\D*/;
            const pubType = code.match(pubtypeRegex)[0].toLowerCase();

            //Category
            for (const categoryID in globals.categories) {
                if (globals.categories[categoryID].jworgCodes.includes(pubType)) {
                    form.category.value = categoryID;
                }
            }

            if (form.category.value == "") {
                form.category.value = 0;
            }

            let languageID;

            languageID = code.split('-').pop();
            if (languageID == code) {
                languageID = "E";
            }

            if (["g", "wp"].includes(pubType)) {

                //Image URL part 1
                let possibleDates = [];

                //Date
                const dateRegex = /(\d+)\.(\d+)/;
                const year = code.match(dateRegex)[1];
                const edition = code.match(dateRegex)[2];

                if (edition == 1) {
                    possibleDates = ["01", "03", "05", "07", "09", "11"];
                } else if (edition == 2) {
                    possibleDates = ["05", "07"];
                } else if (edition == 3) {
                    possibleDates = ["09", "11"];
                }

                let correctDate = "";

                for (let i = 0; i < possibleDates.length; i++) {
                    const possibleDate = possibleDates[i];
                    const possibleURL = `https://cms-imgp.jw-cdn.org/img/p/${pubType}/20${year}${possibleDate}/${languageID}/pt/${pubType}_${languageID}_20${year}${possibleDate}_lg.jpg`

                    const response = await fetch(possibleURL);
                    if (response.ok) {
                        form.imageURL.value = possibleURL;
                        document.getElementById('imagePreview').src = possibleURL;
                        correctDate = "20" + year + "-" + possibleDate + "-01";
                        found = true;
                        break;
                    }
                }

                if (correctDate == "") {
                    document.getElementById('imagePreview').src = "/assets/icons/unknownPublication.png";
                }

                form.date.value = correctDate;
            } else if (code != "") {
                const codeWithoutLanguageID = code.match(/(.+)-/)[1].toLowerCase();

                for (const categoryID in globals.categories) {
                    for (let i = 0; i < globals.categories[categoryID].jworgCodes.length; i++) {
                        if (codeWithoutLanguageID.includes(globals.categories[categoryID].jworgCodes[i])) {
                            form.category.value = categoryID;
                            break;
                        }
                    }
                }

                const possibleURLs = [];
                possibleURLs.push(`https://cms-imgp.jw-cdn.org/img/p/${codeWithoutLanguageID}/${languageID}/pt/${codeWithoutLanguageID}_${languageID}_lg.jpg`);
                possibleURLs.push(`https://cms-imgp.jw-cdn.org/img/p/${codeWithoutLanguageID.toUpperCase()}/${languageID}/pt/${codeWithoutLanguageID.toUpperCase()}_${languageID}_lg.jpg`);

                for (let i = 0; i < possibleURLs.length; i++) {
                    const possibleURL = possibleURLs[i];

                    const response = await fetch(possibleURL);
                    if (response.ok) {
                        form.imageURL.value = possibleURL;
                        document.getElementById('imagePreview').src = possibleURL;
                        found = true;
                        break;
                    }
                }

            }
        } catch (error) {
            console.log(error);
        }

        if (!found) {
            form.imageURL.value = "/assets/icons/unknownPublication.png";
            document.getElementById('imagePreview').src = "/assets/icons/unknownPublication.png";

            openAlertModal("close", "FAILED", "<p class='center'>Publication entering through a code failed.<br>Please check the code entered and try again, or the publication is not (yet) supported.</p>");
        }
    }

    function deletePublication() {
        openYesNoModal("trash", "DELETE PUBLICATION", "<p class='center'>Are you sure you want to delete this publication?<br>All it's data will be lost and every reference will be removed.</p>", "Yes", "No").then((result) => {
            if (result) {

                //Delete publication if not new
                if (!session.newPublication) {

                    //Remove every reference

                    //From designs
                    for (const designID in data.designs) {
                        const design = data.designs[designID];
                        const publications = design.publications;

                        for (let i = 0; i < publications.length; i++) {
                            for (let j = 0; j < publications[i].length; j++) {
                                if (publications[i][j] == session.currentPublicationIndex) {
                                    publications[i][j] = 0;
                                }
                            }
                        }
                    }

                    //From supplies
                    for (const cartID in data.carts) {
                        const cart = data.carts[cartID];
                        const supplies = cart.supplies;

                        delete supplies[session.currentPublicationIndex];
                    }

                    //Remove from library
                    delete data.library[session.currentPublicationIndex];

                    saveData();
                }

                openAlertModal("checkBox", "PUBLICATION DELETED", "<p class='center'>The publication has been deleted successfully.</p>", "Okay").then(() => {
                    navigateBack();
                });
            }
        });
    }

    function deleteNewPublication() {
        if (session.newPublication) {
            delete data.library[session.currentPublicationIndex];
        }

        session.newPublication = false;

        saveData();
    }

    function cancel() {
        session.newPublication = false;

        navigateBack();
    }

    function addSupplies(element, publicationID) {

        numberElement = element.parentElement.childNodes[3];
        numberElement.innerHTML = parseInt(numberElement.innerHTML) + 1;

        updateSupplies(publicationID, 1);
    }

    function removeSupplies(element, publicationID) {

        numberElement = element.parentElement.childNodes[3];

        if (parseInt(numberElement.innerHTML) > 0) {
            numberElement.innerHTML = parseInt(numberElement.innerHTML) - 1;
            updateSupplies(publicationID, -1);
        }
        // } else {
        //     openYesNoModal("trash", "REMOVE PUBLICATION", "<p class='center'>Are you sure you want to remove this publication from the cart supplies?</p>", "Yes", "No").then((result) => {
        //         if (result) {
        //             delete data.carts[session.currentCartIndex].supplies[publicationID];
        //             saveData();
        //             reloadPage();
        //         }
        //     });
        // }
    }

    function updateSupplies(publicationID, quantityChange) {
        if (data.library[publicationID].inventory["General"]) {
            data.library[publicationID].inventory["General"] += quantityChange;
        } else {
            data.library[publicationID].inventory["General"] = 1;
        }

        saveData();
    }
</script>