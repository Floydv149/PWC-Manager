<style>
    #library {
        min-width: 300px;
        width: calc(100% - 10px);
        background: var(--color-content-background-primary);
        max-height: 60vh;
        align-self: flex-start;
        overflow-y: scroll;
        border: 5px solid var(--color-button-background);
        border-radius: 10px;
        overflow-x: hidden;
        box-sizing: border-box;
        margin: 5px;
        padding: 0px 0px 10px 0px;
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    #library::-webkit-scrollbar,
    .publicationRow::-webkit-scrollbar {
        display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    #library,
    .publicationRow {
        -ms-overflow-style: none;
        /* IE and Edge */
        scrollbar-width: none;
        /* Firefox */
    }

    #library .publicationRow {
        width: 100%;
        overflow-x: scroll;
        display: flex;
        flex-direction: row;
        align-items: flex-start;
        justify-content: left;
        gap: 5px;
        padding: 0px 10px;
        box-sizing: border-box;
    }

    #library .publication {
        max-width: 94.29px;
        min-width: 94.29px;
    }

    #library .publication img {
        max-width: 94.29px !important;
        min-width: 94.29px;
        max-height: 128.66px !important;
        min-height: 128.66px;
        object-fit: contain;
        border-radius: 2.5px;
    }

    #library .publication p {
        text-align: center;
        margin: 0px;
        padding: 0px;
    }

    #searchInput {
        width: calc(100% - 20px);
        box-sizing: border-box;
        margin: 10px;
        padding: 10px;
        text-align: center;
        background-image: url("/assets/icons/search.png");
        background-position: 15px 7.5px;
        background-repeat: no-repeat;
        background-size: 20px 20px;
    }
</style>

<body>
    <h2 class="center"><img src="/assets/icons/shelf.png">LIBRARY</h2>
    <p class="center">Edit the publications in your library below.</p>
    <hr>
    <a class="normal rounded full medium" onclick="addPublication()"><img src="/assets/icons/add.png">Add
        publication</a>
    <hr>

    <div id="library">
        <h3><img src="/assets/icons/library.png">Libary</h3>
        <input type="text" id="searchInput" placeholder="Search for a publication" onkeyup="initLibrary()">
        <div id="publications">
        </div>
    </div>
</body>
<script>
    function fuzzySearch(text, query) {
        if (query === "") return true;
        // Maakt van 'abc' -> 'a.*b.*c'
        const pattern = query.split("").join(".*");
        const re = new RegExp(pattern, "i");
        return re.test(text);
    };

    function initLibrary() {
        const library = document.getElementById("publications");
        const search = document.getElementById("searchInput").value.toLowerCase();

        console.log("hi");

        library.innerHTML = "";

        if (Object.keys(data.library).length == 2) {
            library.innerHTML = "<p class='center'>You don't have any publications added yet.</p>";
        } else {
            let output = "";

            const sortedEntries = Object.entries(data.library);

            const sortedLibrary = sortedEntries.sort(([keyA, itemA], [keyB, itemB]) => {
                // --- Primary Sort: categoryID (Ascending) ---
                if (itemA.categoryID !== itemB.categoryID) {
                    return itemA.categoryID - itemB.categoryID;
                }

                const timeA = Date.parse(itemA.date?.trim()) || 0;
                const timeB = Date.parse(itemB.date?.trim()) || 0;
                console.log(timeA, timeB);

                // --- Secondary Sort: date (Descending - Newest First) ---
                // Compare itemA.date (the value part) and itemB.date
                if (timeA !== timeB) {
                    return timeB - timeA;
                }

                // Fallback: If categoryID and date are equal, maintain original order
                return 0;
            });

            let lastCategory = -1;
            let resultCount = 0;

            for (let i = 0; i < sortedLibrary.length; i++) {
                const publicationID = sortedLibrary[i][0];
                const publication = data.library[publicationID];

                if (publicationID != 0 && publicationID != "X" && ((search != "" && (fuzzySearch(publication.title.toLowerCase(), search)) || publication.title.toLowerCase().includes(search)) || search == "")) {
                    resultCount++;

                    publication.categoryID = parseInt(publication.categoryID);
                    publication.date = publication.data;
                    delete publication.data;

                    if (lastCategory != publication.categoryID) {
                        output += `</div>
                    <h4>${globals.categories[publication.categoryID].name}</h4>
                    <div class="publicationRow">`;
                        lastCategory = publication.categoryID;
                    }

                    const publicationCount = (publication.inventory?.["General"] > 0
                        ? publication.inventory["General"] : "");

                    if (publicationID != 0 && publicationID != "X") {
                        output += `<div class="publication" onclick="editPublication(${publicationID})">
                            <img src="${publication.imageURL}">
                                <p>${publicationCount}</p>
                            </div>`;
                    } else {
                        output += `<div class="publication">
                    <img src="${publication.imageURL}">
                </div>`;
                    }
                }
            }

            if (resultCount == 0) {
                output += "<p class='center'>No results found.</p>";
            }

            output += `</div>`;

            library.innerHTML = output;
        }
    }

    initLibrary();

    function editPublication(publicationID) {
        session.currentPublicationIndex = publicationID;

        loadPage("editPublication");
    }

    function addPublication() {
        const availableIndex = getAvailableIndex(data.library);

        const newPublication = { ...defaultData.publication };

        data.library[availableIndex] = newPublication;
        session.currentPublicationIndex = availableIndex;
        session.newPublication = true;

        loadPage("editPublication");
    }
</script>