<style>
    .covers {
        display: flex;
        flex-direction: row;
        align-items: stretch;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin: 5px;
        max-height: 45vh;
        overflow-y: scroll;
    }

    .cover {
        min-width: 150px;
        max-width: 150px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        background: var(--color-content-background-primary);
        border-radius: 10px;
        border: 2.5px solid var(--color-button-hover-background);
        transition: border-color .25s, background .25s;
    }

    .cover:hover {
        background: var(--color-content-background-secondary);
        border-color: var(--color-button-background);
    }

    .cover.selected {
        border-color: #05abf7;
    }

    .coverImage {
        justify-self: left;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .coverImage img {
        border-radius: 10px;
        margin: 0px;
    }

    .title {
        text-align: center;
        padding: 10px;
        align-self: center;
        justify-self: center;
    }

    #editingTable {
        width: calc(100% - 20px);
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        margin: 10px;
        flex-wrap: wrap;
        gap: 10px;
    }

    #design {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 5px;
        flex-wrap: wrap;
    }

    #cover {
        transition: margin .5s;
    }

    #cover img {
        width: 288px;
        height: 640px;
        border-radius: 10px;
        margin: 0px;
    }

    #cartContent {
        min-width: 288px;
        border: 2.5px solid #333333;
        border-radius: 10px;
        box-sizing: border-box;
        background: #1a1a1a;
        width: 288px;
        height: 640px;
        margin: 0px auto;
    }

    #cartContent .cartRow {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 5px;
        border-bottom: 5px solid #333333;
        padding-bottom: 10px;
        margin: 10px 0px;
    }

    #cartContent .cartRow:last-child {
        border-bottom: none;
        padding-bottom: 0px;
        margin-bottom: 0px;
    }

    #cartContent .cartRow .cartPublication {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 45%;
        border: 2.5px solid #ffffff00;
        border-radius: 5px;
        transition: padding .25s, border-color .25s;
    }

    #cartContent .cartRow .cartPublication img {
        width: 100%;
        max-height: 164.42px;
        height: 164.42px;
        transition: width .25s, height .25s, transform .25s;
    }

    #cartContent .cartRow .cartPublication.selected {
        border-color: #05abf7;
        padding: 6.5px 0px;
    }

    #cartContent .cartRow .cartPublication.selected img {
        width: calc(100% - 10px);
        height: 151.56px;
    }

    #library {
        min-width: 250px;
        width: 60%;
        background: var(--color-content-background-primary);
        max-height: 60vh;
        align-self: flex-start;
        overflow-y: scroll;
        border: 2.5px solid var(--color-button-background);
        border-radius: 10px;
        overflow-x: hidden;
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    #library::-webkit-scrollbar,
    .publicationRow::-webkit-scrollbar,
    .covers::-webkit-scrollbar {
        display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    #library,
    .publicationRow,
    .covers {
        -ms-overflow-style: none;
        /* IE and Edge */
        scrollbar-width: none;
        /* Firefox */
    }

    #library .publicationRow {
        width: 100%;
        overflow-x: scroll;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: left;
        gap: 5px;
        padding: 0px 10px;
        box-sizing: border-box;
    }

    #library .publication {
        max-width: 94.29px;
        min-width: 94.29px;
        transition: transform .25s;
    }

    #library .publication img {
        border-radius: 2.5px;
    }

    @media only screen and (max-width: 650px) {
        #cover {
            margin-bottom: -150px;
        }
    }

    @media only screen and (max-width: 820px) {
        #library {
            width: 100%;
        }
    }
</style>

<body>
    <h2 class="center" id="header"><img src="/assets/icons/pen.png">EDIT DESIGN</h2>
    <hr>

    <div id="editingTable">
        <div id="design">
            <div id="cover" onclick="openCoverChooser()">
            </div>
            <div id="cartContent">
            </div>
        </div>
        <div id="library">
            <h3><img src="/assets/icons/library.png">Library</h3>
        </div>
    </div>
    <hr>
    <a class="normal rounded full medium" data-page="editDesign"><img src="/assets/icons/settings.png">Design
        settings</a>
    <a class="normal rounded full medium" onclick="duplicateDesign()"><img src="/assets/icons/duplicate.png">Duplicate
        design</a>
    <a class="normal rounded full medium" onclick="openCoverChooser()"><img src="/assets/icons/cover.png">Choose
        cover</a>
    <a class="normal rounded full medium" onclick="deleteDesign()"><img src="/assets/icons/trash.png">Delete design</a>
</body>
<script>
    function initDesign() {
        const header = document.getElementById("header");
        header.innerHTML += " - " + data.designs[session.currentDesignIndex].name;

        const cartContent = data.designs[session.currentDesignIndex].publications;

        document.getElementById("cover").innerHTML = "<img src='/assets/cartCovers/" + data.covers[data.designs[session.currentDesignIndex].coverID].fileName + "'>";

        let output = "<div ";

        for (let i = 0; i < cartContent.length; i++) {
            output += `<div class="cartRow">`;

            for (let j = 0; j < cartContent[i].length; j++) {
                const publicationID = cartContent[i][j];
                const publication = data.library[publicationID];

                output += `
                <div class="cartPublication" onclick="selectPublication(this, [${i}, ${j}])">
                    <img src="${publication.imageURL}">
                </div>
                `;
            }

            output += `</div>`;
        }

        document.getElementById("cartContent").innerHTML = output;

        let lastCategory = -1;

        output = "";

        const sortedEntries = Object.entries(data.library);

        const sortedLibrary = sortedEntries.sort(([keyA, itemA], [keyB, itemB]) => {
            // --- Primary Sort: categoryID (Ascending) ---
            if (itemA.categoryID !== itemB.categoryID) {
                return itemA.categoryID - itemB.categoryID;
            }

            // --- Secondary Sort: date (Descending - Newest First) ---
            // Compare itemA.date (the value part) and itemB.date
            if (itemA.date > itemB.date) {
                return -1; // 'a' is newer, so it comes first
            }
            if (itemA.date < itemB.date) {
                return 1; // 'b' is newer, so it comes first
            }

            // Fallback: If categoryID and date are equal, maintain original order
            return 0;
        });

        for (let i = 0; i < sortedLibrary.length; i++) {
            const publicationID = sortedLibrary[i][0];
            const publication = data.library[publicationID];

            if (lastCategory != publication.categoryID) {
                output += `</div>
                <h4>`+ data.categories[publication.categoryID].name + `</h4>`;
                lastCategory = publication.categoryID;
                output += `<div class="publicationRow">`;
            }

            output += `
            <div class="publication" onclick="replacePublication(this, '${publicationID}')">
                <img src="${publication.imageURL}">
            </div>
            `;
        }

        output += `</div>
        <hr>
        <a class="normal rounded full small" data-page="library"><img src="/assets/icons/shelf.png">Manage
                library</a>`;

        document.getElementById("library").innerHTML = output;
    }

    initDesign();

    function selectPublication(element, index) {
        const cartPublications = document.getElementsByClassName("cartPublication")

        let deselect = false;

        if (element.classList.contains("selected")) {
            selectedIndex = [-1, -1];
            session.selectedElement = null;
            deselect = true;
        }

        for (let i = 0; i < cartPublications.length; i++) {
            cartPublications[i].classList.remove("selected");
        }

        if (!deselect) {
            session.selectedElement = element;
            selectedIndex = index;
            element.classList.add("selected");
            document.getElementById("library").scrollIntoView();
        }
    }

    function replacePublication(element, id) {
        if (session.selectedElement != null) {
            data.designs[session.currentDesignIndex].publications[selectedIndex[0]][selectedIndex[1]] = id;
            setTimeout(() => {
                element.style.transform = "scale(0.9)";
                setTimeout(function () {
                    element.style.transform = "scale(1)";
                }, 250);
            }, 0);
            document.getElementById("cartContent").scrollIntoView();
            setTimeout(() => {
                session.selectedElement.children[0].style.transform = "scaleY(0)";
                setTimeout(() => {
                    session.selectedElement.children[0].src = data.library[id].imageURL;
                    session.selectedElement.children[0].style.transform = "scaleY(1)";
                }, 250);
            }, 0);
            saveData();
        }
    }

    function openCoverChooser() {
        let modalContent = "<h2 class='center'><img src='/assets/icons/list.png'>CHOOSE COVER</h2><p class='center'>Choose below which of the available covers you want to use for this cart.</p><hr><a class='normal rounded full medium' onclick='closeLastModal()'><img src='/assets/icons/close.png'>Cancel</a><hr>";

        if (data.covers.length == 0) {
            modalContent += "<p class='center'>There are no covers available.</p>";
        } else {
            const sortedEntries = Object.entries(data.covers);

            const sortedCovers = sortedEntries.sort(([keyA, itemA], [keyB, itemB]) => {
                if (keyA == data.designs[session.currentDesignIndex].coverID) {
                    return -1;
                } else {
                    return 1
                }
            });

            modalContent += `<div class="covers">`;

            for (let i = 0; i < sortedCovers.length; i++) {
                const coverID = sortedCovers[i][0];
                const cover = data.covers[coverID];

                if (coverID == data.designs[session.currentDesignIndex].coverID) {
                    modalContent += `
                    <div class="cover selected" onclick="selectCover(` + coverID + `)">
                        <div class="coverImage">
                            <img src="/assets/cartCovers/`+ cover.fileName + `">
                        </div>
                        <div class="title">`+ cover.name + `</div>
                    </div>`;
                } else {
                    modalContent += `
                    <div class="cover" onclick="selectCover(` + coverID + `)">
                        <div class="coverImage">
                            <img src="/assets/cartCovers/`+ cover.fileName + `">
                        </div>
                        <div class="title">`+ cover.name + `</div>
                    </div>`;
                }
            }

            modalContent += `</div>`;

        }

        openModal(modalContent);
    }

    function duplicateDesign() {
        const newDesign = { ...data.designs[session.currentDesignIndex] };
        newDesign.name += " (Copy)";

        data.designs[Object.keys(data.designs).length] = newDesign;
        session.currentCartIndex = Object.keys(data.designs).length - 1;
        session.newDesign = true;

        saveData();

        openDesign(Object.keys(data.designs).length - 1);
    }

    function selectCover(coverID) {
        data.designs[session.currentDesignIndex].coverID = coverID;
        saveData();
        closeLastModal();
        reloadPage();
    }

    function deleteDesign() {
        openYesNoModal("trash", "DELETE DESIGN", "<p class='center'>Are you sure you want to delete this design?<br>All it's data will be lost.</p><p class='center'>This action cannot be undone.</p>", "Yes", "No").then((result) => {
            if (result) {
                let inUse = false;

                for (cartID in data.carts) {
                    const cart = data.carts[cartID];

                    if (cart.designID == session.currentDesignIndex) {
                        inUse = true;
                        break;
                    }
                }

                if (!inUse) {
                    delete data.designs[session.currentDesignIndex];

                    saveData();

                    openAlertModal("checkBox", "DESIGN DELETED", "<p class='center'>The design has been deleted successfully.</p>", "Okay").then(() => {
                        navigateBack();
                    });
                } else {
                    openAlertModal("alert", "DESIGN CANNOT BE DELETED", "<p class='center'>The design cannot be deleted because it is still in use in at least one cart.</p>", "Okay").then(() => {
                    });
                }
            }
        });
    }
</script>