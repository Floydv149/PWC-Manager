<style>
    #cartAppearance {
        display: flex;
        flex-direction: row;
        align-items: stretch;
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
        gap: 10px;
    }

    #cartCover {
        border-radius: 10px;
        width: 144px;
        height: 320px;
        margin: 0px;
    }

    #cartContents {
        border: 2.5px solid #333333;
        border-radius: 10px;
        box-sizing: border-box;
        background: #1a1a1a;
        transition: margin .5s;
        width: 144px;
        height: 320px;
    }

    #cartContents .cartRow {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 5px;
        border-bottom: 5px solid #333333;
    }

    #cartContents .cartRow:last-child {
        border-bottom: none;
    }

    #cartContents .cartRow img {
        width: 46% !important;
        max-height: 82.84px !important;
        object-fit: contain;
    }

    #cartDetails {}

    .interactionProtection {
        position: fixed;
        top: 0;
        left: 0;
        width: 200vw;
        height: 200vh;
        background: rgba(0, 0, 0, 0);
        transition: background-color .5s;
    }

    #designs {
        margin: 10px 0px;
        display: flex;
        flex-direction: row;
        align-items: stretch;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .design {
        width: min-content;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        background: var(--color-content-background-primary);
        border-radius: 10px;
        border: 2.5px solid var(--color-button-hover-background);
        transition: border-color .25s, background .25s;
    }

    .design:hover {
        background: var(--color-content-background-secondary);
        border-color: var(--color-button-background);
    }

    .looks {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .cover {
        justify-self: left;
        width: 96px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .cover img {
        border-radius: 10px;
        margin: 0px;
    }

    .cart {
        border: 2.5px solid #333333;
        border-radius: 10px;
        box-sizing: border-box;
        background: #1a1a1a;
        width: 96px;
        height: 213.333px;
    }

    .cart .cartRow {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        gap: 5px;
        border-bottom: 5px solid #333333;
    }

    .cart .cartRow:last-child {
        border-bottom: none;
    }

    .cart .cartRow img {
        width: 40%;
        max-height: 47.34px;
        object-fit: contain;
    }

    .title {
        text-align: center;
        padding: 10px;
    }

    #editButtons {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
        margin: 5px;
        flex-wrap: wrap;
    }

    #editButtons a {
        width: fit-content;
    }

    #widgets {
        width: 100%;
        display: flex;
        flex-direction: row;
        align-items: space-evenly;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .widget {
        min-width: 200px;
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: flex-start;
        background: var(--color-content-background-primary);
        border-radius: 10px;
        border: 2.5px solid var(--color-button-hover-background);
        padding: 5px;
    }

    .widget.full {
        width: 100%;
    }

    .widget h3 {
        border-radius: 10px;
        margin: 5px;
    }

    .widget h4 {
        border-radius: 10px;
        margin: 5px;
        background: var(--color-header-button-hover);
        border: 2.5px solid var(--color-button-hover-background);
    }

    .widget>img {
        width: 75px;
        padding: 5px;
        border-radius: 10px;
        border: 2.5px solid var(--color-button-hover-background);
    }

    .widget p {
        text-align: center;
        margin: 2.5px;
        padding: 2.5px;
    }

    #statusList {
        margin: 10px 0px;
        display: flex;
        flex-direction: row;
        align-items: stretch;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    #status img:first-child {
        width: 50px;
        display: block;
        margin: -7.5px auto 15px auto;
    }

    .status {
        width: fit-content;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: var(--color-content-background-primary);
        border-radius: 10px;
        border: 2.5px solid var(--color-button-hover-background);
        transition: border-color .25s, background .25s;
    }

    .status:hover {
        background: var(--color-content-background-secondary);
        border-color: var(--color-button-background);
    }

    .status img {
        width: 50px;
    }

    .status .title {
        text-align: center;
    }

    #cartContents.realistic {
        animation: cartContentSlideUp .5s forwards;
    }

    #cartAppearance:has(.realistic) {
        width: 200px;
        margin: 0px auto;
    }

    #realisticViewToggle {
        transition: opacity .25s;
    }

    .red {
        color: #ff5f57;
        filter: drop-shadow(0px .5px 1px #e1473f);
    }

    .widget .publicationSupplies {
        display: flex;
        flex-direction: row;
        justify-content: center;
        align-items: center;
        flex-wrap: nowrap;
        margin: 10px;
    }

    .widget .publicationSupplies img {
        max-width: 100px;
        max-height: 128.66px !important;
        flex: 1;
        border-radius: 5px;
        margin: 0px;
    }

    .widget .publicationSupplies .countControl {
        flex: 1;
        /* max-width: fit-content; */
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: center;
    }

    .widget .publicationSupplies .countControl img {
        margin: 0px;
        display: inline;
        max-width: 25px;
    }

    .widget .publicationSupplies .countControl p {
        padding: 0px 10px;
    }

    .widget .publication h4 {
        /* max-width: 38vw; */
    }

    .widget .split {
        display: flex;
        flex-direction: row;
        align-items: stretch;
        justify-content: space-evenly;
        flex-wrap: wrap;
    }

    .widget .split .publication {
        max-width: 48%;
        min-width: 48%;
        padding: 5px;
        border: 2.5px solid var(--color-button-hover-background);
        border-radius: 10px;
        margin: 5px;
        box-sizing: border-box;
        transition: min-width .25s, max-width .25s;
    }

    #library {
        min-width: 300px;
        width: calc(100% - 10px);
        background: var(--color-content-background-primary);
        max-height: 60vh;
        align-self: flex-start;
        overflow-y: scroll;
        border: 5px solid var(--color-button-background);
        border-radius: 10px;
        overflow-x: hidden;
        box-sizing: border-box;
        margin: 5px;
    }

    /* Hide scrollbar for Chrome, Safari and Opera */
    #library::-webkit-scrollbar,
    .publicationRow::-webkit-scrollbar {
        display: none;
    }

    /* Hide scrollbar for IE, Edge and Firefox */
    #library,
    .publicationRow {
        -ms-overflow-style: none;
        /* IE and Edge */
        scrollbar-width: none;
        /* Firefox */
    }

    #library .publicationRow {
        width: 100%;
        overflow-x: scroll;
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: left;
        gap: 5px;
        padding: 0px 10px;
        box-sizing: border-box;
    }

    #library .publication {
        max-width: 94.29px;
        min-width: 94.29px;
    }

    #library .publication.unselectable {
        opacity: 0.5
    }

    #library .publication img {
        border-radius: 2.5px;
    }

    @media only screen and (max-width: 650px) {
        .widget .split .publication {
            width: 100%;
            max-width: calc(100% - 10px);
        }
    }

    @media only screen and (max-width: 340px) {
        #cartContents {
            animation: cartContentSlideUp .5s forwards;
        }

        #realisticViewToggle {
            opacity: 0;
        }
    }

    @media only screen and (max-width: 490px) {
        .widget {
            width: 100%;
        }
    }

    @keyframes cartContentSlideUp {
        0% {
            margin-top: 0px;
        }

        100% {
            margin-top: -100px;
        }
    }
</style>

<body>
    <h2 class="center" id="header"><img src="/assets/icons/cart.png">Cart</h2>
    <div id="cartAppearance">
        <img onclick="fullScreen(this)" src="/assets/cartCovers/JWORG.png" id="cartCover">
        <div id="cartContents"></div>
    </div>
    <hr>
    <a class="normal rounded full medium" onclick="toggleRealisticView()" id='realisticViewToggle'><img
            src="/assets/icons/eye.png">Change view</a>
    <a class="normal rounded full medium" onclick="editCurrentDesign()"><img src="/assets/icons/pen.png">Edit current
        design</a>
    <a class="normal rounded full medium" onclick="openDesignChooser()"><img src="/assets/icons/list.png">Choose
        design</a>
    <hr>
    <div id="widgets">
        <div class="widget">
            <h3 class="center"><img src="/assets/icons/info.png">General information</h3>
            <h4 class="center" id="storageLocation"><img src="/assets/icons/garage.png">Storage location
                <br><br>
                <a class="normal rounded full small" target="_blank" href="https://www.google.com/maps/place/">
                    <img src="/assets/icons/googleMaps.png">
                </a>
            </h4>
            <h4 class="center" id="responsible"><img src="/assets/icons/person.png">Responsible:</h4>
            <h4 class="center" id="design"><img src="/assets/icons/rulerPen.png">Design:</h4>
            <h4 class="center" id="number"><img src="/assets/icons/hashtag.png">Number</h4>
        </div>
        <div class="widget">
            <h3 class="center"><img src="/assets/icons/status.png">Status</h3>
            <div id="status" onclick="changeCartStatus()"></div>
            <h4 class=" center" id="lastMaintenance" onclick="editLastMaintenance();">
                <img src="/assets/icons/clean.png">Laatste onderhoud:<br>
                <img src='/assets/icons/pen.png'>
            </h4>
        </div>
        <div class="widget" onclick="editComments(this);">
            <h3 class="center"><img src="/assets/icons/note.png" onclick="editComments()">Comments</h3>
            <p id="comments">
        </div>
        <div class="widget full">
            <h3 class="center" id="supplies"><img src="/assets/icons/shelf.png">Supplies</h3>

            <div id="cartSupplies"></div>

            <hr>

            <a class='normal rounded full small' onclick='addSuppliesPublication();'><img
                    src='/assets/icons/add.png'>Add
                supplies</a>
            <a class='normal rounded full small' onclick='resetSupplies();'><img src='/assets/icons/trash.png'>Reset
                supplies</a>
        </div>
    </div>
    <br>
    <a class="normal rounded full medium" data-page="editCart"><img src="/assets/icons/settings.png">Edit cart
        settings</a>
    <a class="normal rounded full medium" onclick="deleteCart()"><img src="/assets/icons/trash.png">Delete cart</a>
    </div>
</body>
<script>

    function initCart() {
        session.isRealisticView = false;

        const cart = data.carts[session.currentCartIndex];
        const cartContents = document.getElementById("cartContents");

        let location;
        let address;
        if (cart.locationID in data.locations) {
            location = data.locations[cart.locationID].name;
            address = data.locations[cart.locationID].address;
        } else {
            location = "No location";
            address = "";
        }

        document.getElementById('header').innerHTML = "<img src='/assets/icons/cart.png'>" + cart.name;

        document.getElementById("cartCover").src = "/assets/cartCovers/" + globals.covers[data.designs[cart.designID].coverID].fileName;
        cartContents.innerHTML = generateCartContentHTML(data.designs[cart.designID].publications);

        document.getElementById("storageLocation").innerHTML = "<img src='/assets/icons/garage.png'>Storage location<br><br>" + location

        if (address != "") {
            document.getElementById("storageLocation").innerHTML += "<a class='normal rounded full small' target='_blank' href='https://www.google.com/maps/place/" + address + "''><img src='/assets/icons/googleMaps.png'>" + address + "</a>";
        }

        if (cart.responsible == "") {
            document.getElementById("responsible").innerHTML = "<img src='/assets/icons/person.png'>No responsible";
        } else {
            document.getElementById("responsible").innerHTML = "<img src='/assets/icons/person.png'>Responsible:<br>" + cart.responsible;
        }
        document.getElementById("design").innerHTML = "<img src='/assets/icons/rulerPen.png'>Design:<br>" + data.designs[cart.designID].name;
        document.getElementById("number").innerHTML = "<img src='/assets/icons/hashtag.png'>Number:<br>" + cart.number;

        document.getElementById("status").innerHTML = "<h4 class='center'><img src='/assets/icons/" + defaultData.statusses[cart.statusID].image + ".png'>" + defaultData.statusses[cart.statusID].name + " <img src='/assets/icons/pen.png'></h4>";
        document.getElementById("lastMaintenance").innerHTML = "<img src='/assets/icons/clean.png'>Last maintenance:<br>" + cart.lastCleaned + " <img src='/assets/icons/pen.png'>";

        if (cart.comments == "") {
            document.getElementById("comments").innerHTML = "No comments <img src='/assets/icons/add.png'>";
        } else {
            document.getElementById("comments").innerHTML = cart.comments + " <img src='/assets/icons/pen.png'>";
        }

        const cartSupplies = document.getElementById("cartSupplies");

        if (Object.keys(cart.supplies).length === 0) {
            cartSupplies.innerHTML = "<br><p class='center'>No supplies have been added yet.</p>";
        } else {

            let cartSuppliesContent = "<div class='split'>";

            for (const publicationID in cart.supplies) {
                const publication = data.library[publicationID];

                cartSuppliesContent += `
                <div class="publication">
                    <h4 class="center">`+ publication.title + `</h4>
                    <div class="publicationSupplies">
                        <img onclick="fullScreen(this)" src="`+ publication.imageURL + `">
                        <div class="countControl">
                            <img src="/assets/icons/remove.png" onclick="removeSupplies(this, '`+ publicationID + `')">
                            <p>`+ cart.supplies[publicationID] + `</p>
                            <img src="/assets/icons/add.png" onclick="addSupplies(this, '`+ publicationID + `')">
                        </div>
                    </div>
                </div>
            `;
            }

            cartSuppliesContent += "</div>";

            cartSupplies.innerHTML = cartSuppliesContent;
        }
    }

    initCart();

    function addSupplies(element, publicationID) {

        numberElement = element.parentElement.childNodes[3];
        numberElement.innerHTML = parseInt(numberElement.innerHTML) + 1;

        updateSupplies(publicationID, 1);
    }

    function removeSupplies(element, publicationID) {

        numberElement = element.parentElement.childNodes[3];

        if (parseInt(numberElement.innerHTML) > 0) {
            numberElement.innerHTML = parseInt(numberElement.innerHTML) - 1;
            updateSupplies(publicationID, -1);
        } else {
            openYesNoModal("trash", "REMOVE PUBLICATION", "<p class='center'>Are you sure you want to remove this publication from the cart supplies?</p>", "Yes", "No").then((result) => {
                if (result) {
                    delete data.carts[session.currentCartIndex].supplies[publicationID];
                    saveData();
                    reloadPage();
                }
            });
        }
    }

    function updateSupplies(publicationID, quantityChange) {
        data.carts[session.currentCartIndex].supplies[publicationID] += quantityChange;

        saveData();
    }

    function toggleRealisticView() {
        const cartContents = document.getElementById("cartContents");
        session.isRealisticView = !session.isRealisticView;

        if (session.isRealisticView) {
            cartContents.classList.add("realistic");
            realisticViewToggle.innerHTML = "<img src='/assets/icons/eyeClosed.png'>Change view";
        } else {
            cartContents.classList.remove("realistic");
            realisticViewToggle.innerHTML = "<img src='/assets/icons/eye.png'>Change view";
        }
    }

    function openDesignChooser() {
        let modalContent = "<h2 class='center'><img src='/assets/icons/list.png'>CHOOSE THE DESIGN</h2><p class='center'>Choose below which of the available designs you want to apply to this cart.</p><hr><a class='normal rounded full medium' onclick='closeLastModal()'><img src='/assets/icons/close.png'>Cancel</a><hr>";

        if (data.designs.length == 0) {
            modalContent += "<p class='center'>There are no designs available. Please add designs first.</p>";
        } else {
            modalContent += `<div id="designs">`;

            for (const designID in data.designs) {
                const design = data.designs[designID];

                modalContent += `<div class="design" onclick="setCartDesign(` + designID + `)">
                <div class="looks">
                    <div class="cover">
                        <img src="/assets/cartCovers/`+ globals.covers[design.coverID].fileName + `">
                    </div>
                    <div class="cart">`;

                modalContent += generateCartContentHTML(design.publications, false);

                modalContent += `</div>
                </div>
                <div class="title">`+ design.name + `</div>
            </div>`;
            }

            modalContent += `</div>`;

        }

        openModal(modalContent);
    }

    function setCartDesign(designID) {
        data.carts[session.currentCartIndex].designID = designID;

        saveData();
        reloadPage();

        closeLastModal();
    }

    function deleteCart() {
        openYesNoModal("trash", "DELETE CART", "<p class='center'>Are you sure you want to delete this cart?<br>All it's data will be lost.</p><p class='center'>This action cannot be undone.</p>", "Yes", "No").then((result) => {
            if (result) {
                delete data.carts[session.currentCartIndex];

                saveData();

                openAlertModal("checkBox", "CART DELETED", "<p class='center'>The cart has been deleted successfully.</p>", "Okay").then(() => {
                    navigateBack();
                });
            }
        });
    }

    //Statusses
    // 0: Ready to use
    // 1: Needs maintenance
    // 2: Under maintenance
    // 3: Unavailable

    function changeCartStatus() {
        let modalContent = `
            <h2 class="center"><img src="/assets/icons/status.png">CHANGE STATUS</h2>
            <p class="center">Change the status for this cart.</p>
            <hr>
            <div id="statusList">`;

        for (const statusID in defaultData.statusses) {
            modalContent += `<div class="status" onclick="setStatus('` + statusID + `')">
                <img src="/assets/icons/`+ defaultData.statusses[statusID].image + `.png">
                <div class="title">`+ defaultData.statusses[statusID].name + `</div>
            </div>`
        }

        modalContent += `</div>
        <hr>
        <a class="normal rounded full medium" onclick="saveStatus()"><img src="/assets/icons/save.png">Save changes</a>
        <a class="normal rounded full medium" onclick="closeLastModal();"><img src="/assets/icons/close.png">Cancel</a>`;

        openModal(modalContent);
    }

    function setStatus(type) {
        data.carts[session.currentCartIndex].statusID = type;

        saveData();
        closeLastModal();
        reloadPage();
    }

    function editLastMaintenance() {
        openModal(`
            <h2 class="center"><img src="/assets/icons/clean.png">EDIT LAST MAINTENANCE</h2>
            <p class="center">Edit the last maintenance date for this cart.</p>
            <hr>
            <form id="editLastMaintenanceForm">
                <div class="formGroup">
                    <input type="date" name="lastMaintenance" required value="${data.carts[session.currentCartIndex].lastCleaned}">
                </div>
            </form>
            <a class="normal rounded small full" onclick="setMaintenanceToday()"><img src="/assets/icons/calendar.png">Set to today</a>
            <hr>
            <a class="normal rounded full medium" onclick="saveLastMaintenance()"><img src="/assets/icons/save.png">Save changes</a>
            <a class="normal rounded full medium" onclick="closeLastModal();"><img src="/assets/icons/close.png">Cancel</a>
        `);
    }

    function setMaintenanceToday() {
        const form = document.getElementById('editLastMaintenanceForm');
        const today = new Date().toISOString().split('T')[0];
        form.lastMaintenance.value = today;
    }

    function saveLastMaintenance() {
        const form = document.getElementById('editLastMaintenanceForm');

        data.carts[session.currentCartIndex].lastCleaned = form.lastMaintenance.value;

        saveData();
        reloadPage();

        closeLastModal();
    }

    function editComments() {
        openModal(`
            <h2 class="center"><img src="/assets/icons/note.png">EDIT COMMENTS</h2>
            <p class="center">Edit the comments for this cart.</p>
            <hr>
            <form id="editCommentsForm">
                <div class="formGroup">
                    <textarea name="comments" placeholder="Enter comments here..." required>${data.carts[session.currentCartIndex].comments}</textarea>
                </div>
            </form>
            <hr>
            <a class="normal rounded full medium" onclick="saveComments()"><img src="/assets/icons/save.png">Save changes</a>
            <a class="normal rounded full medium" onclick="closeLastModal();"><img src="/assets/icons/close.png">Cancel</a>
        `);
    }

    function saveComments(locationID) {
        const form = document.getElementById('editCommentsForm');

        data.carts[session.currentCartIndex].comments = form.comments.value;

        saveData();
        reloadPage();

        closeLastModal();
    }

    function resetSupplies() {
        openYesNoModal("trash", "RESET SUPPLIES", "<p class='center'>Are you sure you want to reset all supplies in this cart?</p><p class='center'>This action cannot be undone.</p>", "Yes", "No").then((result) => {
            if (result) {
                const newSupplies = {};
                const designPublications = data.designs[data.carts[session.currentCartIndex].designID].publications;

                for (let i = 0; i < designPublications.length; i++) {
                    for (let j = 0; j < designPublications[i].length; j++) {
                        if (designPublications[i][j] != 0) {
                            newSupplies[designPublications[i][j]] = 0;
                        }
                    }
                }

                data.carts[session.currentCartIndex].supplies = newSupplies;
                saveData();
                reloadPage();
            }
        });
    }

    function editCurrentDesign() {
        session.currentDesignIndex = data.carts[session.currentCartIndex].designID;
        loadPage("designDetails");
    }

    function addSuppliesPublication() {
        let lastCategory = -1;

        output = "<div id='library'>";

        const sortedEntries = Object.entries(data.library);

        const sortedLibrary = sortedEntries.sort(([keyA, itemA], [keyB, itemB]) => {
            // --- Primary Sort: categoryID (Ascending) ---
            if (itemA.categoryID !== itemB.categoryID) {
                return itemA.categoryID - itemB.categoryID;
            }

            // --- Secondary Sort: date (Descending - Newest First) ---
            // Compare itemA.date (the value part) and itemB.date
            if (itemA.date > itemB.date) {
                return -1; // 'a' is newer, so it comes first
            }
            if (itemA.date < itemB.date) {
                return 1; // 'b' is newer, so it comes first
            }

            // Fallback: If categoryID and date are equal, maintain original order
            return 0;
        });

        for (let i = 0; i < sortedLibrary.length; i++) {
            const publicationID = sortedLibrary[i][0];
            const publication = data.library[publicationID];

            if (publicationID != 0) {
                if (lastCategory != publication.categoryID) {
                    if (lastCategory != -1) {
                        output += `</div>`;
                    }
                    output += `<h4>` + globals.categories[publication.categoryID].name + `</h4>`;
                    lastCategory = publication.categoryID;
                    output += `<div class="publicationRow">`;
                }

                if (publicationID in data.carts[session.currentCartIndex].supplies) {
                    output += `
            <div class="publication unselectable">
                <img src="${publication.imageURL}">
            </div>
            `;
                } else {
                    output += `
            <div class="publication" onclick="addPublicationToSupplies('${publicationID}')">
                <img src="${publication.imageURL}">
            </div>
            `;
                }
            }
        }

        output += `</div><hr>
        <a class="normal rounded full small" onclick="openLibrary()"><img src="/assets/icons/shelf.png">Manage
                library</a>
        </div>`;

        openModal(`
            <h2 class="center"><img src="/assets/icons/add.png">ADD SUPPLIES</h2>
            <p class="center">Add a publication to the supplies of this cart.</p>
            <hr>
            ${output}
            <a class="normal rounded full medium" onclick="closeLastModal();"><img src="/assets/icons/close.png">Cancel</a>
        `)
    }

    function openLibrary() {
        loadPage("library");
        closeLastModal();
    }

    function addPublicationToSupplies(publicationID) {
        data.carts[session.currentCartIndex].supplies[publicationID] = 0;
        saveData();
        closeLastModal();
        reloadPage();
    }

</script>